{
  "openapi": "3.0.3",
  "info": {
    "title": "GlookoDataWebApp API",
    "description": "API for the GlookoDataWebApp application. All endpoints require authentication via Microsoft Personal Account using Bearer token (ID token from MSAL authentication).",
    "version": "1.0.0",
    "contact": {
      "name": "GlookoDataWebApp",
      "url": "https://github.com/iricigor/GlookoDataWebApp"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "/api",
      "description": "Azure Static Web App API"
    }
  ],
  "tags": [
    {
      "name": "User",
      "description": "User management operations"
    },
    {
      "name": "AI",
      "description": "AI analysis operations for Pro users"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/user/check-first-login": {
      "get": {
        "tags": ["User"],
        "summary": "Check if user is logging in for the first time",
        "description": "Checks if a user is logging in for the first time by querying the UserSettings table in Azure Table Storage. If it's a first login, creates a new user record. If returning user, updates the last login date.",
        "operationId": "checkFirstLogin",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully checked login status",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CheckFirstLoginResponse"
                },
                "examples": {
                  "firstLogin": {
                    "summary": "First time user",
                    "value": {
                      "isFirstLogin": true,
                      "userId": "user-abc123"
                    }
                  },
                  "returningUser": {
                    "summary": "Returning user",
                    "value": {
                      "isFirstLogin": false,
                      "userId": "user-abc123"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "storageNotConfigured": {
                    "summary": "Storage not configured",
                    "value": {
                      "error": "Service unavailable - storage not configured",
                      "errorType": "infrastructure",
                      "code": "STORAGE_NOT_CONFIGURED"
                    }
                  },
                  "storageAccessDenied": {
                    "summary": "Storage access denied",
                    "value": {
                      "error": "Service unavailable - storage access denied",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ACCESS_DENIED"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/user/check-pro-status": {
      "get": {
        "tags": ["User"],
        "summary": "Check if user is a pro user",
        "description": "Checks if a user is a pro user by querying the ProUsers table in Azure Table Storage. Pro users receive special features and are indicated with a âœ¨ symbol.",
        "operationId": "checkProStatus",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully checked pro status",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CheckProStatusResponse"
                },
                "examples": {
                  "proUser": {
                    "summary": "Pro user",
                    "value": {
                      "isProUser": true,
                      "userId": "user-abc123"
                    }
                  },
                  "regularUser": {
                    "summary": "Regular user",
                    "value": {
                      "isProUser": false,
                      "userId": "user-abc123"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "storageNotConfigured": {
                    "summary": "Storage not configured",
                    "value": {
                      "error": "Service unavailable - storage not configured",
                      "errorType": "infrastructure",
                      "code": "STORAGE_NOT_CONFIGURED"
                    }
                  },
                  "storageAccessDenied": {
                    "summary": "Storage access denied",
                    "value": {
                      "error": "Service unavailable - storage access denied",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ACCESS_DENIED"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/user/settings": {
      "get": {
        "tags": ["User"],
        "summary": "Get user settings",
        "description": "Retrieves the user's saved settings from Azure Table Storage.",
        "operationId": "getUserSettings",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved settings",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GetSettingsResponse"
                },
                "example": {
                  "settings": {
                    "themeMode": "dark",
                    "exportFormat": "csv",
                    "responseLanguage": "english",
                    "glucoseUnit": "mmol/L",
                    "insulinDuration": 4,
                    "glucoseThresholds": {
                      "veryHigh": 13.9,
                      "high": 10.0,
                      "low": 3.9,
                      "veryLow": 3.0
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "404": {
            "description": "No settings found for user",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "No settings found",
                  "errorType": "not_found"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": ["User"],
        "summary": "Save user settings",
        "description": "Saves the user's settings to Azure Table Storage. Creates or updates the user record.",
        "operationId": "saveUserSettings",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SaveSettingsRequest"
              },
              "example": {
                "settings": {
                  "themeMode": "dark",
                  "exportFormat": "csv",
                  "responseLanguage": "english",
                  "glucoseUnit": "mmol/L",
                  "insulinDuration": 4,
                  "glucoseThresholds": {
                    "veryHigh": 13.9,
                    "high": 10.0,
                    "low": 3.9,
                    "veryLow": 3.0
                  }
                },
                "email": "user@example.com"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Settings saved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                },
                "example": {
                  "success": true
                }
              }
            }
          },
          "400": {
            "description": "Bad request - Missing settings in request body",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Missing settings in request body",
                  "errorType": "validation"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/ai/query": {
      "post": {
        "tags": ["AI"],
        "summary": "Query AI providers with diabetes-related prompts",
        "description": "Allows Pro users to query AI providers (Perplexity, Gemini, Grok, or DeepSeek) through the backend, keeping API keys secure in Azure Key Vault. The function validates the user's authentication token, verifies Pro user status, validates that the prompt is diabetes-related, and makes the AI API call on behalf of the user. Implements rate limiting (50 requests per hour per user) and abuse detection.",
        "operationId": "aiQuery",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AIQueryRequest"
              },
              "examples": {
                "perplexity": {
                  "summary": "Query with Perplexity provider",
                  "value": {
                    "prompt": "Analyze this blood glucose data: 120, 130, 145, 160, 140 mg/dL over the past 5 hours. What patterns do you see?",
                    "provider": "perplexity"
                  }
                },
                "autoSelect": {
                  "summary": "Auto-select provider",
                  "value": {
                    "prompt": "What are the signs of hypoglycemia and how should I respond?"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "AI query successful",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AIQueryResponse"
                },
                "example": {
                  "success": true,
                  "content": "Based on the glucose readings you provided, I can see a gradual upward trend from 120 to 160 mg/dL over 5 hours...",
                  "provider": "perplexity"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid request (missing prompt, prompt too long, or non-diabetes prompt)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "missingPrompt": {
                    "summary": "Missing prompt",
                    "value": {
                      "error": "Prompt is required",
                      "errorType": "validation",
                      "code": "MISSING_PROMPT"
                    }
                  },
                  "promptTooLong": {
                    "summary": "Prompt exceeds maximum length",
                    "value": {
                      "error": "Prompt exceeds maximum length of 50000 characters",
                      "errorType": "validation",
                      "code": "PROMPT_TOO_LONG"
                    }
                  },
                  "nonDiabetesPrompt": {
                    "summary": "Prompt is not diabetes-related",
                    "value": {
                      "error": "Prompt must be diabetes-related",
                      "errorType": "validation",
                      "code": "NON_DIABETES_PROMPT"
                    }
                  },
                  "invalidProvider": {
                    "summary": "Invalid provider specified",
                    "value": {
                      "error": "Invalid provider. Supported providers: perplexity, gemini, grok, deepseek",
                      "errorType": "validation",
                      "code": "INVALID_PROVIDER"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Not a Pro user or rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "notProUser": {
                    "summary": "User is not a Pro user",
                    "value": {
                      "error": "This endpoint is only available to Pro users",
                      "errorType": "forbidden",
                      "code": "NOT_PRO_USER"
                    }
                  },
                  "rateLimitExceeded": {
                    "summary": "Rate limit exceeded",
                    "value": {
                      "error": "Rate limit exceeded. Maximum 50 requests per hour.",
                      "errorType": "rate_limit",
                      "code": "RATE_LIMIT_EXCEEDED"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal server error - Infrastructure error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "keyVaultError": {
                    "summary": "Failed to retrieve API key from Key Vault",
                    "value": {
                      "error": "Failed to retrieve API key from Key Vault",
                      "errorType": "infrastructure",
                      "code": "KEY_VAULT_ERROR"
                    }
                  },
                  "storageError": {
                    "summary": "Storage access error",
                    "value": {
                      "error": "Failed to access rate limit storage",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ERROR"
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - AI provider unavailable or error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "AI provider is currently unavailable. Please try again later.",
                  "errorType": "provider",
                  "code": "PROVIDER_UNAVAILABLE"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "ID token from Microsoft Authentication (MSAL). Use the 'Authenticate' button above to sign in with your Microsoft account and automatically set this token."
      }
    },
    "schemas": {
      "CheckFirstLoginResponse": {
        "type": "object",
        "required": ["isFirstLogin", "userId"],
        "properties": {
          "isFirstLogin": {
            "type": "boolean",
            "description": "True if this is the user's first login"
          },
          "userId": {
            "type": "string",
            "description": "Unique identifier for the user"
          }
        }
      },
      "CheckProStatusResponse": {
        "type": "object",
        "required": ["isProUser", "userId"],
        "properties": {
          "isProUser": {
            "type": "boolean",
            "description": "True if the user is a pro user"
          },
          "userId": {
            "type": "string",
            "description": "Unique identifier for the user"
          }
        }
      },
      "CloudUserSettings": {
        "type": "object",
        "required": ["themeMode", "exportFormat", "responseLanguage", "glucoseUnit", "insulinDuration", "glucoseThresholds"],
        "properties": {
          "themeMode": {
            "type": "string",
            "enum": ["light", "dark", "system"],
            "description": "UI theme preference"
          },
          "exportFormat": {
            "type": "string",
            "enum": ["csv", "tsv"],
            "description": "Data export format preference"
          },
          "responseLanguage": {
            "type": "string",
            "enum": ["english", "czech", "german", "serbian"],
            "description": "Language for AI responses"
          },
          "glucoseUnit": {
            "type": "string",
            "enum": ["mmol/L", "mg/dL"],
            "description": "Preferred glucose unit"
          },
          "insulinDuration": {
            "type": "number",
            "description": "Insulin active duration in hours"
          },
          "glucoseThresholds": {
            "$ref": "#/components/schemas/GlucoseThresholds"
          }
        }
      },
      "GlucoseThresholds": {
        "type": "object",
        "required": ["veryHigh", "high", "low", "veryLow"],
        "properties": {
          "veryHigh": {
            "type": "number",
            "description": "Very high glucose threshold (mmol/L)"
          },
          "high": {
            "type": "number",
            "description": "High glucose threshold (mmol/L)"
          },
          "low": {
            "type": "number",
            "description": "Low glucose threshold (mmol/L)"
          },
          "veryLow": {
            "type": "number",
            "description": "Very low glucose threshold (mmol/L)"
          }
        }
      },
      "GetSettingsResponse": {
        "type": "object",
        "required": ["settings"],
        "properties": {
          "settings": {
            "$ref": "#/components/schemas/CloudUserSettings"
          }
        }
      },
      "SaveSettingsRequest": {
        "type": "object",
        "required": ["settings"],
        "properties": {
          "settings": {
            "$ref": "#/components/schemas/CloudUserSettings"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User's email address"
          }
        }
      },
      "SuccessResponse": {
        "type": "object",
        "required": ["success"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indicates if the operation was successful"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": ["error", "errorType"],
        "properties": {
          "error": {
            "type": "string",
            "description": "Human-readable error message"
          },
          "errorType": {
            "type": "string",
            "enum": ["unauthorized", "not_found", "validation", "infrastructure"],
            "description": "Type of error for client handling"
          },
          "code": {
            "type": "string",
            "description": "Optional error code for specific errors"
          }
        }
      },
      "AIQueryRequest": {
        "type": "object",
        "required": ["prompt"],
        "properties": {
          "prompt": {
            "type": "string",
            "description": "The AI prompt text (must be diabetes-related, max 50,000 characters)",
            "maxLength": 50000,
            "example": "Analyze this blood glucose data: 120, 130, 145 mg/dL. What patterns do you see?"
          },
          "provider": {
            "type": "string",
            "enum": ["perplexity", "gemini", "grok", "deepseek"],
            "description": "AI provider to use (optional, defaults to backend's configured provider)",
            "example": "perplexity"
          }
        }
      },
      "AIQueryResponse": {
        "type": "object",
        "required": ["success", "content", "provider"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Whether the query was successful",
            "example": true
          },
          "content": {
            "type": "string",
            "description": "The AI-generated response content",
            "example": "Based on the glucose readings you provided, I can see a gradual upward trend..."
          },
          "provider": {
            "type": "string",
            "description": "The AI provider that was used to generate the response",
            "example": "perplexity"
          }
        }
      }
    }
  }
}
