{
  "openapi": "3.0.3",
  "info": {
    "title": "GlookoDataWebApp API",
    "description": "API for the GlookoDataWebApp application. All endpoints require authentication via Microsoft Personal Account using Bearer token (ID token from MSAL authentication).",
    "version": "1.0.0",
    "contact": {
      "name": "GlookoDataWebApp",
      "url": "https://github.com/iricigor/GlookoDataWebApp"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "/api",
      "description": "Azure Static Web App API"
    }
  ],
  "tags": [
    {
      "name": "User",
      "description": "User management operations"
    },
    {
      "name": "AI",
      "description": "AI analysis operations for Pro users"
    },
    {
      "name": "Admin",
      "description": "Administrative operations for Pro users"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/user/check-first-login": {
      "get": {
        "tags": ["User"],
        "summary": "Check if user is logging in for the first time",
        "description": "Checks if a user is logging in for the first time by querying the UserSettings table in Azure Table Storage. If it's a first login, creates a new user record. If returning user, updates the last login date.",
        "operationId": "checkFirstLogin",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully checked login status",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CheckFirstLoginResponse"
                },
                "examples": {
                  "firstLogin": {
                    "summary": "First time user",
                    "value": {
                      "isFirstLogin": true,
                      "userId": "user-abc123"
                    }
                  },
                  "returningUser": {
                    "summary": "Returning user",
                    "value": {
                      "isFirstLogin": false,
                      "userId": "user-abc123"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "storageNotConfigured": {
                    "summary": "Storage not configured",
                    "value": {
                      "error": "Service unavailable - storage not configured",
                      "errorType": "infrastructure",
                      "code": "STORAGE_NOT_CONFIGURED"
                    }
                  },
                  "storageAccessDenied": {
                    "summary": "Storage access denied",
                    "value": {
                      "error": "Service unavailable - storage access denied",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ACCESS_DENIED"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/user/check-pro-status": {
      "get": {
        "tags": ["User"],
        "summary": "Check if user is a pro user",
        "description": "Checks if a user is a pro user by querying the ProUsers table in Azure Table Storage. Pro users receive special features and are indicated with a âœ¨ symbol.",
        "operationId": "checkProStatus",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully checked pro status",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CheckProStatusResponse"
                },
                "examples": {
                  "proUser": {
                    "summary": "Pro user",
                    "value": {
                      "isProUser": true,
                      "userId": "user-abc123"
                    }
                  },
                  "regularUser": {
                    "summary": "Regular user",
                    "value": {
                      "isProUser": false,
                      "userId": "user-abc123"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "storageNotConfigured": {
                    "summary": "Storage not configured",
                    "value": {
                      "error": "Service unavailable - storage not configured",
                      "errorType": "infrastructure",
                      "code": "STORAGE_NOT_CONFIGURED"
                    }
                  },
                  "storageAccessDenied": {
                    "summary": "Storage access denied",
                    "value": {
                      "error": "Service unavailable - storage access denied",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ACCESS_DENIED"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/user/settings": {
      "get": {
        "tags": ["User"],
        "summary": "Get user settings",
        "description": "Retrieves the user's saved settings from Azure Table Storage.",
        "operationId": "getUserSettings",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved settings",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GetSettingsResponse"
                },
                "example": {
                  "settings": {
                    "themeMode": "dark",
                    "exportFormat": "csv",
                    "responseLanguage": "english",
                    "glucoseUnit": "mmol/L",
                    "insulinDuration": 4,
                    "glucoseThresholds": {
                      "veryHigh": 13.9,
                      "high": 10.0,
                      "low": 3.9,
                      "veryLow": 3.0
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "404": {
            "description": "No settings found for user",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "No settings found",
                  "errorType": "not_found"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": ["User"],
        "summary": "Save user settings",
        "description": "Saves the user's settings to Azure Table Storage. Creates or updates the user record.",
        "operationId": "saveUserSettings",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SaveSettingsRequest"
              },
              "example": {
                "settings": {
                  "themeMode": "dark",
                  "exportFormat": "csv",
                  "responseLanguage": "english",
                  "glucoseUnit": "mmol/L",
                  "insulinDuration": 4,
                  "glucoseThresholds": {
                    "veryHigh": 13.9,
                    "high": 10.0,
                    "low": 3.9,
                    "veryLow": 3.0
                  }
                },
                "email": "user@example.com"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Settings saved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                },
                "example": {
                  "success": true
                }
              }
            }
          },
          "400": {
            "description": "Bad request - Missing settings in request body",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Missing settings in request body",
                  "errorType": "validation"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/ai/query": {
      "post": {
        "tags": ["AI"],
        "summary": "Query AI providers with diabetes-related prompts",
        "description": "Allows Pro users to query AI providers (Perplexity, Gemini, Grok, or DeepSeek) through the backend, keeping API keys secure in Azure Key Vault. The backend automatically selects the provider based on the AI_PROVIDER environment variable. The function validates the user's authentication token, verifies Pro user status, validates that the prompt is diabetes-related, and makes the AI API call on behalf of the user. Implements rate limiting (50 requests per hour per user) and abuse detection.",
        "operationId": "aiQuery",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AIQueryRequest"
              },
              "examples": {
                "basicQuery": {
                  "summary": "Diabetes-related query",
                  "value": {
                    "prompt": "You are a diabetes expert. Analyze this blood glucose data: 120, 130, 145, 160, 140 mg/dL over the past 5 hours. What patterns do you see?"
                  }
                },
                "hypoglycemiaQuery": {
                  "summary": "Query about hypoglycemia",
                  "value": {
                    "prompt": "You are a diabetes expert. What are the signs of hypoglycemia and how should I respond?"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "AI query successful",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AIQueryResponse"
                },
                "example": {
                  "success": true,
                  "content": "Based on the glucose readings you provided, I can see a gradual upward trend from 120 to 160 mg/dL over 5 hours...",
                  "provider": "perplexity"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid request (missing prompt, prompt too long, or non-diabetes prompt)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "missingPrompt": {
                    "summary": "Missing prompt",
                    "value": {
                      "error": "Prompt is required",
                      "errorType": "validation",
                      "code": "MISSING_PROMPT"
                    }
                  },
                  "promptTooLong": {
                    "summary": "Prompt exceeds maximum length",
                    "value": {
                      "error": "Prompt exceeds maximum length of 50000 characters",
                      "errorType": "validation",
                      "code": "PROMPT_TOO_LONG"
                    }
                  },
                  "nonDiabetesPrompt": {
                    "summary": "Prompt is not diabetes-related",
                    "value": {
                      "error": "Prompt must be diabetes-related",
                      "errorType": "validation",
                      "code": "NON_DIABETES_PROMPT"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - Not a Pro user or rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "notProUser": {
                    "summary": "User is not a Pro user",
                    "value": {
                      "error": "This endpoint is only available to Pro users",
                      "errorType": "forbidden",
                      "code": "NOT_PRO_USER"
                    }
                  },
                  "rateLimitExceeded": {
                    "summary": "Rate limit exceeded",
                    "value": {
                      "error": "Rate limit exceeded. Maximum 50 requests per hour.",
                      "errorType": "rate_limit",
                      "code": "RATE_LIMIT_EXCEEDED"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal server error - Infrastructure error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "keyVaultError": {
                    "summary": "Failed to retrieve API key from Key Vault",
                    "value": {
                      "error": "Failed to retrieve API key from Key Vault",
                      "errorType": "infrastructure",
                      "code": "KEY_VAULT_ERROR"
                    }
                  },
                  "storageError": {
                    "summary": "Storage access error",
                    "value": {
                      "error": "Failed to access rate limit storage",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ERROR"
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - AI provider unavailable or error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "AI provider is currently unavailable. Please try again later.",
                  "errorType": "provider",
                  "code": "PROVIDER_UNAVAILABLE"
                }
              }
            }
          }
        }
      }
    },
    "/glookoAdmin/stats/traffic": {
      "get": {
        "tags": ["Admin"],
        "summary": "Get API and web traffic statistics",
        "description": "Returns API and web traffic statistics from Application Insights for the specified time period. This endpoint is only accessible to Pro users and provides counts of web requests, web errors, API requests, and API errors.",
        "operationId": "getTrafficStats",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "timePeriod",
            "in": "query",
            "description": "Time period for statistics",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["1hour", "1day"],
              "default": "1hour"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved traffic statistics",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TrafficStatsResponse"
                },
                "examples": {
                  "success": {
                    "summary": "Successful statistics retrieval",
                    "value": {
                      "webCalls": 8642,
                      "webErrors": 23,
                      "apiCalls": 1245,
                      "apiErrors": 5,
                      "timePeriod": "1hour"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid timePeriod parameter",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Invalid timePeriod parameter: invalid. Supported values: 1hour, 1day",
                  "errorType": "validation"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - User is not a Pro user",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Access denied. This endpoint requires Pro user access.",
                  "errorType": "authorization"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Application Insights not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "appInsightsNotConfigured": {
                    "summary": "Application Insights not configured",
                    "value": {
                      "error": "Service unavailable - Application Insights not configured",
                      "errorType": "infrastructure",
                      "code": "APPINSIGHTS_NOT_CONFIGURED"
                    }
                  },
                  "appInsightsQueryError": {
                    "summary": "Application Insights query error",
                    "value": {
                      "error": "Failed to query Application Insights",
                      "errorType": "infrastructure",
                      "code": "APPINSIGHTS_QUERY_ERROR"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/glookoAdmin/stats": {
      "get": {
        "tags": ["Admin"],
        "summary": "Get all administrative statistics (unified endpoint)",
        "description": "Returns all administrative statistics in a single call: logged-in users count, Pro users count, and API/Web statistics from Application Insights. This endpoint is only accessible to Pro users and provides a convenient way to fetch all admin statistics at once.",
        "operationId": "getUnifiedAdminStats",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "timePeriod",
            "in": "query",
            "description": "Time period for API and Web statistics",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["1hour", "1day"],
              "default": "1hour"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved all administrative statistics",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UnifiedAdminStatsResponse"
                },
                "examples": {
                  "success": {
                    "summary": "Successful statistics retrieval",
                    "value": {
                      "loggedInUsersCount": 1523,
                      "proUsersCount": 42,
                      "webCalls": 8642,
                      "webErrors": 23,
                      "apiCalls": 1245,
                      "apiErrors": 5,
                      "timePeriod": "1hour"
                    }
                  },
                  "capped": {
                    "summary": "User counts capped at limit",
                    "value": {
                      "loggedInUsersCount": 100000,
                      "proUsersCount": 100000,
                      "webCalls": 8642,
                      "webErrors": 23,
                      "apiCalls": 1245,
                      "apiErrors": 5,
                      "timePeriod": "1hour",
                      "capped": true,
                      "proUsersCapped": true
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid timePeriod parameter",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Invalid timePeriod parameter: invalid. Supported values: 1hour, 1day",
                  "errorType": "validation"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - User is not a Pro user",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Access denied. This endpoint requires Pro user access.",
                  "errorType": "authorization"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured or access denied",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "storageNotConfigured": {
                    "summary": "Storage not configured",
                    "value": {
                      "error": "Service unavailable - storage not configured",
                      "errorType": "infrastructure",
                      "code": "STORAGE_NOT_CONFIGURED"
                    }
                  },
                  "storageAccessDenied": {
                    "summary": "Storage access denied",
                    "value": {
                      "error": "Service unavailable - storage access denied",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ACCESS_DENIED"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/glookoAdmin/stats/logged-in-users": {
      "get": {
        "tags": ["Admin"],
        "summary": "Get count of logged-in users",
        "description": "Returns the total count of users who have logged into the application at least once. This endpoint is only accessible to Pro users and provides administrative statistics. The count is retrieved from the UserSettings table in Azure Table Storage.",
        "operationId": "getLoggedInUsersCount",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved logged-in users count",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LoggedInUsersCountResponse"
                },
                "examples": {
                  "success": {
                    "summary": "Successful count retrieval",
                    "value": {
                      "count": 1523,
                      "capped": false
                    }
                  },
                  "capped": {
                    "summary": "Count capped at limit",
                    "value": {
                      "count": 100000,
                      "capped": true
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - User is not a Pro user",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Access denied. This endpoint requires Pro user access.",
                  "errorType": "authorization"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Internal server error",
                  "errorType": "infrastructure"
                }
              }
            }
          },
          "503": {
            "description": "Service unavailable - Storage not configured or access denied",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "storageNotConfigured": {
                    "summary": "Storage not configured",
                    "value": {
                      "error": "Service unavailable - storage not configured",
                      "errorType": "infrastructure",
                      "code": "STORAGE_NOT_CONFIGURED"
                    }
                  },
                  "storageAccessDenied": {
                    "summary": "Storage access denied",
                    "value": {
                      "error": "Service unavailable - storage access denied",
                      "errorType": "infrastructure",
                      "code": "STORAGE_ACCESS_DENIED"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/glookoAdmin/test-ai-key": {
      "post": {
        "tags": ["Admin"],
        "summary": "Test Pro AI key configuration",
        "description": "Allows Pro users with admin access to test the Pro AI key configuration. Supports two test modes: **Infrastructure test** (verifies Key Vault access and environment configuration) and **Full test** (includes infrastructure test plus sends a test query to the configured AI provider). The AI provider is determined by the backend's AI_PROVIDER environment variable.",
        "operationId": "testProAIKey",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "testType",
            "in": "query",
            "description": "Type of test to perform: 'infra' for infrastructure test only (Key Vault access), or 'full' for infrastructure test plus AI provider response test",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["infra", "full"],
              "default": "full"
            }
          }
        ],
        "requestBody": {
          "required": false,
          "description": "Request body is not used by this endpoint. The AI provider is determined by the backend's AI_PROVIDER environment variable. An empty JSON object can be sent for consistency with other POST endpoints.",
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {}
              },
              "examples": {
                "empty": {
                  "summary": "Empty request body (recommended)",
                  "value": {}
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Test successful",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AdminTestAIResponse"
                },
                "examples": {
                  "infraTest": {
                    "summary": "Infrastructure test successful",
                    "value": {
                      "success": true,
                      "testType": "infra",
                      "provider": "perplexity",
                      "keyVaultName": "my-key-vault",
                      "secretName": "AI-API-Key",
                      "secretExists": true,
                      "message": "Infrastructure test successful. Key Vault access confirmed."
                    }
                  },
                  "fullTest": {
                    "summary": "Full test successful",
                    "value": {
                      "success": true,
                      "testType": "full",
                      "provider": "perplexity",
                      "keyVaultName": "my-key-vault",
                      "secretName": "AI-API-Key",
                      "secretExists": true,
                      "message": "AI provider test successful. Response: Hello! I'm working correctly and ready to help..."
                    }
                  }
                }
              }
            }
          },
          "206": {
            "description": "Partial Content - Infrastructure test completed but secret not found or accessible",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AdminTestAIResponse"
                },
                "example": {
                  "success": false,
                  "testType": "infra",
                  "provider": "perplexity",
                  "keyVaultName": "my-key-vault",
                  "secretName": "AI-API-Key",
                  "secretExists": false,
                  "error": "Failed to retrieve secret: Secret not found in Key Vault"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request - Invalid testType parameter",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Invalid testType parameter: invalid. Supported values: infra, full",
                  "errorType": "validation"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Unauthorized access. Please log in again.",
                  "errorType": "unauthorized"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - User is not a Pro user",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Access denied. This endpoint requires Pro user access.",
                  "errorType": "authorization"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error - Key Vault or configuration error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "examples": {
                  "keyVaultError": {
                    "summary": "Key Vault access error",
                    "value": {
                      "error": "Failed to retrieve API key configuration",
                      "errorType": "infrastructure",
                      "code": "KEY_VAULT_ERROR",
                      "testType": "full",
                      "provider": "perplexity",
                      "keyVaultName": "my-key-vault",
                      "secretName": "AI-API-Key",
                      "secretExists": false
                    }
                  },
                  "invalidProviderConfig": {
                    "summary": "Invalid provider configured in backend",
                    "value": {
                      "error": "Invalid provider configured: invalid-provider. Supported providers: perplexity, gemini, grok, deepseek",
                      "errorType": "infrastructure",
                      "code": "INVALID_PROVIDER_CONFIG"
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "Service Unavailable - AI provider error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "AI provider test failed: Perplexity API error (401): Invalid API key",
                  "errorType": "provider",
                  "code": "PROVIDER_ERROR",
                  "testType": "full",
                  "provider": "perplexity",
                  "keyVaultName": "my-key-vault",
                  "secretName": "AI-API-Key",
                  "secretExists": true
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "ID token from Microsoft Authentication (MSAL). Use the 'Authenticate' button above to sign in with your Microsoft account and automatically set this token."
      }
    },
    "schemas": {
      "CheckFirstLoginResponse": {
        "type": "object",
        "required": ["isFirstLogin", "userId"],
        "properties": {
          "isFirstLogin": {
            "type": "boolean",
            "description": "True if this is the user's first login"
          },
          "userId": {
            "type": "string",
            "description": "Unique identifier for the user"
          }
        }
      },
      "CheckProStatusResponse": {
        "type": "object",
        "required": ["isProUser", "userId"],
        "properties": {
          "isProUser": {
            "type": "boolean",
            "description": "True if the user is a pro user"
          },
          "userId": {
            "type": "string",
            "description": "Unique identifier for the user"
          }
        }
      },
      "CloudUserSettings": {
        "type": "object",
        "required": ["themeMode", "exportFormat", "responseLanguage", "glucoseUnit", "insulinDuration", "glucoseThresholds"],
        "properties": {
          "themeMode": {
            "type": "string",
            "enum": ["light", "dark", "system"],
            "description": "UI theme preference"
          },
          "exportFormat": {
            "type": "string",
            "enum": ["csv", "tsv"],
            "description": "Data export format preference"
          },
          "responseLanguage": {
            "type": "string",
            "enum": ["english", "czech", "german", "serbian"],
            "description": "Language for AI responses"
          },
          "glucoseUnit": {
            "type": "string",
            "enum": ["mmol/L", "mg/dL"],
            "description": "Preferred glucose unit"
          },
          "insulinDuration": {
            "type": "number",
            "description": "Insulin active duration in hours"
          },
          "glucoseThresholds": {
            "$ref": "#/components/schemas/GlucoseThresholds"
          }
        }
      },
      "GlucoseThresholds": {
        "type": "object",
        "required": ["veryHigh", "high", "low", "veryLow"],
        "properties": {
          "veryHigh": {
            "type": "number",
            "description": "Very high glucose threshold (mmol/L)"
          },
          "high": {
            "type": "number",
            "description": "High glucose threshold (mmol/L)"
          },
          "low": {
            "type": "number",
            "description": "Low glucose threshold (mmol/L)"
          },
          "veryLow": {
            "type": "number",
            "description": "Very low glucose threshold (mmol/L)"
          }
        }
      },
      "GetSettingsResponse": {
        "type": "object",
        "required": ["settings"],
        "properties": {
          "settings": {
            "$ref": "#/components/schemas/CloudUserSettings"
          }
        }
      },
      "SaveSettingsRequest": {
        "type": "object",
        "required": ["settings"],
        "properties": {
          "settings": {
            "$ref": "#/components/schemas/CloudUserSettings"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User's email address"
          }
        }
      },
      "SuccessResponse": {
        "type": "object",
        "required": ["success"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indicates if the operation was successful"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": ["error", "errorType"],
        "properties": {
          "error": {
            "type": "string",
            "description": "Human-readable error message"
          },
          "errorType": {
            "type": "string",
            "enum": ["unauthorized", "not_found", "validation", "infrastructure"],
            "description": "Type of error for client handling"
          },
          "code": {
            "type": "string",
            "description": "Optional error code for specific errors"
          }
        }
      },
      "AIQueryRequest": {
        "type": "object",
        "required": ["prompt"],
        "properties": {
          "prompt": {
            "type": "string",
            "description": "The AI prompt text (must be diabetes-related, max 50,000 characters)",
            "maxLength": 50000,
            "example": "You are a diabetes expert. Analyze this blood glucose data: 120, 130, 145 mg/dL. What patterns do you see?"
          }
        }
      },
      "AIQueryResponse": {
        "type": "object",
        "required": ["success", "content", "provider"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Whether the query was successful",
            "example": true
          },
          "content": {
            "type": "string",
            "description": "The AI-generated response content",
            "example": "Based on the glucose readings you provided, I can see a gradual upward trend..."
          },
          "provider": {
            "type": "string",
            "description": "The AI provider that was used to generate the response",
            "example": "perplexity"
          }
        }
      },
      "LoggedInUsersCountResponse": {
        "type": "object",
        "required": ["count"],
        "properties": {
          "count": {
            "type": "integer",
            "description": "The total number of users who have logged in at least once",
            "example": 1523
          },
          "capped": {
            "type": "boolean",
            "description": "Whether the count was capped at the maximum limit (100,000). If true, actual count may be higher.",
            "example": false
          }
        }
      },
      "TrafficStatsResponse": {
        "type": "object",
        "required": ["webCalls", "webErrors", "apiCalls", "apiErrors", "timePeriod"],
        "properties": {
          "webCalls": {
            "type": "integer",
            "description": "Number of web requests (non-API) in the specified time period",
            "example": 8642
          },
          "webErrors": {
            "type": "integer",
            "description": "Number of web request errors in the specified time period",
            "example": 23
          },
          "apiCalls": {
            "type": "integer",
            "description": "Number of API requests in the specified time period",
            "example": 1245
          },
          "apiErrors": {
            "type": "integer",
            "description": "Number of API request errors in the specified time period",
            "example": 5
          },
          "timePeriod": {
            "type": "string",
            "enum": ["1hour", "1day"],
            "description": "Time period for the statistics",
            "example": "1hour"
          }
        }
      },
      "UnifiedAdminStatsResponse": {
        "type": "object",
        "required": ["loggedInUsersCount", "proUsersCount", "webCalls", "webErrors", "apiCalls", "apiErrors", "timePeriod"],
        "properties": {
          "loggedInUsersCount": {
            "type": "integer",
            "description": "The total number of users who have logged in at least once",
            "example": 1523
          },
          "proUsersCount": {
            "type": "integer",
            "description": "The total number of Pro users",
            "example": 42
          },
          "webCalls": {
            "type": "integer",
            "description": "Number of web requests (non-API) in the specified time period",
            "example": 8642
          },
          "webErrors": {
            "type": "integer",
            "description": "Number of web request errors in the specified time period",
            "example": 23
          },
          "apiCalls": {
            "type": "integer",
            "description": "Number of API requests in the specified time period",
            "example": 1245
          },
          "apiErrors": {
            "type": "integer",
            "description": "Number of API request errors in the specified time period",
            "example": 5
          },
          "timePeriod": {
            "type": "string",
            "enum": ["1hour", "1day"],
            "description": "Time period for API and Web statistics",
            "example": "1hour"
          },
          "capped": {
            "type": "boolean",
            "description": "Whether the logged-in users count was capped at the maximum limit (100,000). If true, actual count may be higher.",
            "example": false
          },
          "proUsersCapped": {
            "type": "boolean",
            "description": "Whether the Pro users count was capped at the maximum limit (100,000). If true, actual count may be higher.",
            "example": false
          }
        }
      },
      "AdminTestAIRequest": {
        "type": "object",
        "description": "Request body for testing AI configuration. Currently not used - provider is determined by backend environment configuration (AI_PROVIDER). The body can be empty.",
        "properties": {}
      },
      "AdminTestAIResponse": {
        "type": "object",
        "required": ["success", "testType", "provider"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Whether the test was successful",
            "example": true
          },
          "testType": {
            "type": "string",
            "enum": ["infra", "full"],
            "description": "Type of test that was performed",
            "example": "full"
          },
          "provider": {
            "type": "string",
            "description": "The AI provider configured in the backend (from AI_PROVIDER environment variable)",
            "example": "perplexity"
          },
          "keyVaultName": {
            "type": "string",
            "description": "Name of the Azure Key Vault being used (from KEY_VAULT_NAME environment variable). Present in all responses except validation errors.",
            "example": "my-key-vault"
          },
          "secretName": {
            "type": "string",
            "description": "Name of the secret in Key Vault containing the AI API key (from AI_API_KEY_SECRET environment variable). Present in all responses except validation errors.",
            "example": "AI-API-Key"
          },
          "secretExists": {
            "type": "boolean",
            "description": "Whether the secret was found and accessible in Key Vault. Present in all responses except validation errors.",
            "example": true
          },
          "message": {
            "type": "string",
            "description": "Test result message. For infrastructure tests, confirms Key Vault access. For full tests, includes a preview of the AI provider response. Only present when success is true.",
            "example": "AI provider test successful. Response: Hello! I'm working correctly..."
          },
          "error": {
            "type": "string",
            "description": "Error message if the test failed. Only present when success is false.",
            "example": "Failed to retrieve secret: Secret not found in Key Vault"
          }
        }
      }
    }
  }
}
