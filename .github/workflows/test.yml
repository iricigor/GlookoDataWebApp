name: ðŸ§ª Test & Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run linter
        run: npm run lint

  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build project
        run: npm run build

  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run unit tests with JSON reporter
        run: npm test -- --run --reporter=json > test-results.json 2>&1 || true

      - name: Extract Test Statistics
        if: always()
        run: |
          # Extract test count from JSON output
          TEST_COUNT=$(grep -o '"numTotalTests":[0-9]*' test-results.json | head -1 | grep -o '[0-9]*' || echo "0")
          TEST_PASSED=$(grep -o '"numPassedTests":[0-9]*' test-results.json | head -1 | grep -o '[0-9]*' || echo "0")
          TEST_FAILED=$(grep -o '"numFailedTests":[0-9]*' test-results.json | head -1 | grep -o '[0-9]*' || echo "0")
          
          echo "TESTS_TOTAL=$TEST_COUNT" >> $GITHUB_ENV
          echo "TESTS_PASSED=$TEST_PASSED" >> $GITHUB_ENV
          echo "TESTS_FAILED=$TEST_FAILED" >> $GITHUB_ENV
          
          echo "::notice::Tests: $TEST_PASSED/$TEST_COUNT passed"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: test-results.json
          retention-days: 7

  # Summary job that runs after all parallel jobs complete
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [lint, build, unit-tests]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: ./results

      - name: Aggregate results
        run: |
          # Extract test count from JSON output
          TEST_COUNT=$(grep -o '"numTotalTests":[0-9]*' ./results/test-results.json | head -1 | grep -o '[0-9]*' || echo "0")
          TEST_PASSED=$(grep -o '"numPassedTests":[0-9]*' ./results/test-results.json | head -1 | grep -o '[0-9]*' || echo "0")
          TEST_FAILED=$(grep -o '"numFailedTests":[0-9]*' ./results/test-results.json | head -1 | grep -o '[0-9]*' || echo "0")
          
          echo "TESTS_TOTAL=$TEST_COUNT" >> $GITHUB_ENV
          echo "TESTS_PASSED=$TEST_PASSED" >> $GITHUB_ENV
          echo "TESTS_FAILED=$TEST_FAILED" >> $GITHUB_ENV
          
          echo "::notice::Tests: $TEST_PASSED/$TEST_COUNT passed"

      - name: Check job statuses
        run: |
          # Array of job results
          jobs=("lint:${{ needs.lint.result }}" "build:${{ needs.build.result }}" "unit-tests:${{ needs.unit-tests.result }}")
          failed=false
          
          for job in "${jobs[@]}"; do
            name="${job%%:*}"
            result="${job#*:}"
            echo "$name: $result"
            if [[ "$result" == "failure" ]]; then
              failed=true
            fi
          done
          
          if [[ "$failed" == "true" ]]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi

      - name: Update Test Count Badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        if: github.ref == 'refs/heads/main' && always()
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: d15ec8d49e21d87f7b2fd54869d44085
          filename: glookodata-webapp-tests.json
          label: tests
          message: ${{ env.TESTS_PASSED }}/${{ env.TESTS_TOTAL }} passing
          color: ${{ env.TESTS_FAILED == '0' && 'brightgreen' || 'critical' }}
